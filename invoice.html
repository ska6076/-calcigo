<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vintage Glass Arts - Invoice</title>
    <link rel="stylesheet" href="invoice.css" />
</head>

<body>
    <div class="invoice-container">
        <header class="invoice-header">
            <div class="company-info">
                <h1>Vintage Glass Arts</h1>
                <p class="address-line">Shop address: Near Owaisi Hospital, LB Nagar Road</p>
                <p class="address-line">Hyderabad - 500059</p>
                <p>Phone: 7661843421</p>
                <p>Email: advs@gmail.com</p>
            </div>
            <div class="invoice-meta">
                <h2>Estimate / Quotation</h2>
                <div class="meta-row">
                    <label for="invoice-number">Estimate No:</label>
                    <input id="invoice-number" type="text" placeholder="E-001" />
                </div>
                <div class="meta-row">
                    <label for="invoice-date">Date:</label>
                    <input id="invoice-date" type="date" />
                </div>
            </div>
        </header>

        <section class="party-info">
            <div class="block">
                <h3>Customer Details</h3>
                <div class="field-row">
                    <label for="customer-name">Name:</label>
                    <input id="customer-name" type="text" placeholder="Customer name" />
                </div>
                <div class="field-row">
                    <label for="site-name">Site Name:</label>
                    <input id="site-name" type="text" placeholder="Site / Project location" />
                </div>
            </div>
        </section>

        <section class="items-section">
            <table id="items-table">
                <thead>
                    <tr>
                        <th>S. No</th>
                        <th>Description</th>
                        <th>Quantity</th>
                        <th>Size</th>
                        <th>Sqft</th>
                        <th>Rate / Sqft</th>
                        <th>Amount</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="items-body">
                    <!-- Rows will be added dynamically by JavaScript -->
                </tbody>
            </table>
            <button id="add-row-btn" type="button">Add Item</button>
        </section>

        <section class="totals-section">
            <div class="amount-row">
                <span>Transportation Cost:</span>
                <input id="transportation-cost" type="number" min="0" step="0.01" value="0" />
            </div>
            <div class="amount-row">
                <span>Sub Total:</span>
                <span id="sub-total"></span>
            </div>
            <div class="gst-row">
                <span>CGST (0%):</span>
                <span id="cgst-amount"></span>
            </div>
            <div class="gst-row">
                <span>SGST (0%):</span>
                <span id="sgst-amount"></span>
            </div>
            <div class="amount-row grand-total">
                <span>Grand Total:</span>
                <span id="grand-total"></span>
            </div>
        </section>

        <section class="note-section">
            <p><strong>NOTE:</strong> 50% Advance is must.</p>
        </section>

        <section class="actions-section">
            <button id="download-btn" type="button">Download / Print Invoice</button>
        </section>
    </div>

    <script>
        (function () {
            const itemsBody = document.getElementById("items-body");
            const addRowBtn = document.getElementById("add-row-btn");
            const downloadBtn = document.getElementById("download-btn");
            const subTotalEl = document.getElementById("sub-total");
            const grandTotalEl = document.getElementById("grand-total");
            const cgstAmountEl = document.getElementById("cgst-amount");
            const sgstAmountEl = document.getElementById("sgst-amount");
            const transportationInput = document.getElementById("transportation-cost");
            const invoiceNumberInput = document.getElementById("invoice-number");
            const invoiceDateInput = document.getElementById("invoice-date");
            const ESTIMATE_STORAGE_KEY = "vga_last_estimate_number";
            const START_ESTIMATE_NUMBER = 1001001;

            function createCell(tag, className) {
                const cell = document.createElement(tag);
                if (className) cell.className = className;
                return cell;
            }

            function parseNumber(value) {
                const n = parseFloat(value);
                return isNaN(n) ? 0 : n;
            }

            function recalculateTotals() {
                let subTotal = 0;

                const rows = itemsBody.querySelectorAll("tr");
                rows.forEach((row) => {
                    const sqftInput = row.querySelector(".sqft-input");
                    const rateInput = row.querySelector(".rate-input");
                    const amountCell = row.querySelector(".amount-cell");

                    const sqft = parseNumber(sqftInput?.value);
                    const rate = parseNumber(rateInput?.value);
                    const amount = sqft * rate;

                    if (amountCell) {
                        amountCell.textContent = amount.toFixed(2);
                    }

                    subTotal += amount;
                });

                subTotalEl.textContent = subTotal.toFixed(2);

                const transportation = transportationInput
                    ? parseNumber(transportationInput.value)
                    : 0;

                // GST split into CGST and SGST (both currently 0%).
                const cgstRate = 0;
                const sgstRate = 0;
                const cgstAmount = subTotal * (cgstRate / 100);
                const sgstAmount = subTotal * (sgstRate / 100);

                if (cgstAmountEl) {
                    cgstAmountEl.textContent = cgstAmount.toFixed(2);
                }
                if (sgstAmountEl) {
                    sgstAmountEl.textContent = sgstAmount.toFixed(2);
                }

                const grandTotal = subTotal + transportation + cgstAmount + sgstAmount;
                grandTotalEl.textContent = grandTotal.toFixed(2);
            }

            function initInvoiceDate() {
                if (!invoiceDateInput) return;

                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, "0");
                const day = String(now.getDate()).padStart(2, "0");
                invoiceDateInput.value = `${year}-${month}-${day}`;
            }

            // Show current estimate number (no increment on load).
            function initEstimateNumber() {
                if (!invoiceNumberInput) return;

                let currentNumber = START_ESTIMATE_NUMBER;

                try {
                    if (typeof localStorage !== "undefined") {
                        const lastValue = localStorage.getItem(ESTIMATE_STORAGE_KEY);

                        if (lastValue === null) {
                            // First estimate number: 7-digit starting value
                            currentNumber = START_ESTIMATE_NUMBER;
                        } else {
                            const parsed = parseInt(lastValue, 10);
                            // If stored value is invalid or below the configured start, reset to start; otherwise use stored value
                            currentNumber = isNaN(parsed) || parsed < START_ESTIMATE_NUMBER
                                ? START_ESTIMATE_NUMBER
                                : parsed;
                        }

                        localStorage.setItem(ESTIMATE_STORAGE_KEY, String(currentNumber));
                    }
                } catch (e) {
                    // If localStorage is not accessible (e.g., file:// restrictions), just fall back to START_ESTIMATE_NUMBER.
                    currentNumber = START_ESTIMATE_NUMBER;
                }

                const formatted = String(currentNumber); // keep natural 7-digit formatting
                invoiceNumberInput.value = formatted;
            }

            // Increment estimate number AFTER printing, for the next use.
            function incrementEstimateNumberForNextUse() {
                if (!invoiceNumberInput) return;

                let currentNumber = START_ESTIMATE_NUMBER;

                try {
                    if (typeof localStorage !== "undefined") {
                        const lastValue = localStorage.getItem(ESTIMATE_STORAGE_KEY);

                        if (lastValue === null) {
                            currentNumber = START_ESTIMATE_NUMBER;
                        } else {
                            const parsed = parseInt(lastValue, 10);
                            currentNumber = isNaN(parsed) || parsed < START_ESTIMATE_NUMBER
                                ? START_ESTIMATE_NUMBER
                                : parsed;
                        }

                        const nextNumber = currentNumber + 1;
                        invoiceNumberInput.value = String(nextNumber);
                        localStorage.setItem(ESTIMATE_STORAGE_KEY, String(nextNumber));
                        return;
                    }
                } catch (e) {
                    // If localStorage fails, just increment in-memory.
                    currentNumber = START_ESTIMATE_NUMBER;
                }

                // Fallback path when localStorage is not available: just bump from what is currently shown.
                const shown = parseInt(invoiceNumberInput.value, 10);
                const base = isNaN(shown) || shown < START_ESTIMATE_NUMBER ? START_ESTIMATE_NUMBER : shown;
                const next = base + 1;
                invoiceNumberInput.value = String(next);
            }

            function renumberRows() {
                const rows = itemsBody.querySelectorAll("tr");
                rows.forEach((row, index) => {
                    const serialCell = row.querySelector(".serial-cell");
                    if (serialCell) {
                        serialCell.textContent = String(index + 1);
                    }
                });
            }

            function attachInputListeners(row) {
                const inputs = row.querySelectorAll("input");
                inputs.forEach((input) => {
                    input.addEventListener("input", recalculateTotals);
                });
            }

            function addRow() {
                const row = document.createElement("tr");

                // S. No
                const serialCell = createCell("td", "serial-cell");
                row.appendChild(serialCell);

                // Description
                const descCell = createCell("td");
                const descInput = document.createElement("input");
                descInput.type = "text";
                descInput.placeholder = "Description";
                descCell.appendChild(descInput);
                row.appendChild(descCell);

                // Quantity
                const qtyCell = createCell("td");
                const qtyInput = document.createElement("input");
                qtyInput.type = "number";
                qtyInput.min = "0";
                qtyInput.step = "1";
                qtyInput.placeholder = "Qty";
                qtyCell.appendChild(qtyInput);
                row.appendChild(qtyCell);

                // Size
                const sizeCell = createCell("td");
                const sizeInput = document.createElement("input");
                sizeInput.type = "text";
                sizeInput.placeholder = "Size";
                sizeCell.appendChild(sizeInput);
                row.appendChild(sizeCell);

                // Sqft
                const sqftCell = createCell("td");
                const sqftInput = document.createElement("input");
                sqftInput.type = "number";
                sqftInput.min = "0";
                sqftInput.step = "0.01";
                sqftInput.placeholder = "Sqft";
                sqftInput.className = "sqft-input";
                sqftCell.appendChild(sqftInput);
                row.appendChild(sqftCell);

                // Rate / Sqft
                const rateCell = createCell("td");
                const rateInput = document.createElement("input");
                rateInput.type = "number";
                rateInput.min = "0";
                rateInput.step = "0.01";
                rateInput.placeholder = "Rate";
                rateInput.className = "rate-input";
                rateCell.appendChild(rateInput);
                row.appendChild(rateCell);

                // Amount
                const amountCell = createCell("td", "amount-cell");
                amountCell.textContent = "0.00";
                row.appendChild(amountCell);

                // Action (Remove button)
                const actionCell = createCell("td");
                const removeBtn = document.createElement("button");
                removeBtn.type = "button";
                removeBtn.className = "remove-row-btn";
                removeBtn.textContent = "Remove";
                removeBtn.addEventListener("click", () => {
                    row.remove();
                    renumberRows();
                    recalculateTotals();
                });
                actionCell.appendChild(removeBtn);
                row.appendChild(actionCell);

                itemsBody.appendChild(row);

                attachInputListeners(row);
                renumberRows();
                recalculateTotals();
            }

            // Initialize date, estimate number and one empty row
            initInvoiceDate();
            initEstimateNumber();
            addRow();

            // Recalculate totals when transportation cost changes
            if (transportationInput) {
                transportationInput.addEventListener("input", recalculateTotals);
            }

            if (addRowBtn) {
                addRowBtn.addEventListener("click", addRow);
            }

            if (downloadBtn) {
                downloadBtn.addEventListener("click", () => {
                    const previousTitle = document.title;
                    const customerNameInput = document.getElementById("customer-name");
                    const rawName = customerNameInput ? customerNameInput.value.trim() : "";
                    const safeName = rawName ? rawName.replace(/\s+/g, "_") : "customer";

                    // The browser typically uses document.title as the suggested PDF file name.
                    document.title = `${safeName}_Vintage Glass Arts`;
                    window.print();

                    // Restore the original title shortly after triggering print and prepare next estimate number.
                    setTimeout(() => {
                        document.title = previousTitle;
                        incrementEstimateNumberForNextUse();
                    }, 1000);
                });
            }
        })();
    </script>
</body>

</html>